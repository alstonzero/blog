<!DOCTYPE html>
<html lang="zh-TW">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">

    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->

    

    
        <meta name="description" content="單晶片、即時作業系統與韌體相關之技術筆記">
    

    <!--Author-->
    
        <meta name="author" content="LuSkywalker">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="XV6 Ch2 Page tables">
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="單晶片、即時作業系統與韌體相關之技術筆記">
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="技術筆記">

    <!--Type page-->
    
        <meta property="og:type" content="article">
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="http://blog.lusw.devhttp://www.codeblocq.com/assets/projects/hexo-theme-clean-blog/img/home-bg.jpg">
    

        <meta name="twitter:card" content="summary_large_image">

    

    
        <meta name="twitter:image" content="http://blog.lusw.devhttp://www.codeblocq.com/assets/projects/hexo-theme-clean-blog/img/home-bg.jpg">
    

    <!-- Title -->
    
    <title>XV6 Ch2 Page tables - 技術筆記</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">
    <link href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet">

    <!-- Google Analytics -->
    


    <!-- favicon -->
    
    <link rel="icon" href="/img/favicon.png">
    

<link rel="alternate" href="/atom.xml" title="技術筆記" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>


<body>

    <!-- hexo-inject:begin --><!-- hexo-inject:end --><!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">技術筆記</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/tags/Linux">
                            
                                Linux
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags/RT-Thread">
                            
                                RT-Thread
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags/XV6">
                            
                                XV6
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags/Clang">
                            
                                C Lang
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/luswdev">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('http://www.codeblocq.com/assets/projects/hexo-theme-clean-blog/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>XV6 Ch2 Page tables</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2018-07-23
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-categories">
                    
                        

<a href="/categories/XV6/">XV6</a>

                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><blockquote>
<p>File: vm.c</p>
</blockquote>
<h2 id="分頁硬體"><a href="#分頁硬體" class="headerlink" title="分頁硬體"></a>分頁硬體</h2><ul>
<li>PTE：Page table entry，包含 20-bit PPN 及 flags</li>
<li>PPN：Physical Page number</li>
<li>x86的頁表：$2^{20}$ 條 PTE。</li>
</ul>
<h3 id="目標"><a href="#目標" class="headerlink" title="目標"></a>目標</h3><blockquote>
<p>分頁硬體使用虛擬位址找到對應的 PTE，接著把高 20-bit 替換為 PTE 的 PPN，低 12-bit 直接沿用，即完成轉譯的動作。</p>
</blockquote>
<h3 id="XV6-頁表"><a href="#XV6-頁表" class="headerlink" title="XV6 頁表"></a>XV6 頁表</h3><p><img src="https://i.imgur.com/Jj4vbJt.png" alt="" title="x86 page table hardware."></p>
<ul>
<li>一個頁表在物理記憶體中為一顆兩層的樹<ul>
<li>樹根為一個 4096 字節的目錄（page dir），包含 1024 個類 PTE，分別指向不同的頁表頁（page table page）。</li>
<li>每頁包含 1024 個 32-bit PTE。</li>
</ul>
</li>
<li>轉譯過程<ol>
<li>分頁硬體用虛擬地址的高 10-bit 找到指定的頁。</li>
<li>如果指向的頁存在的話，繼續使用接著的 10-bit 來找到指定的 PTE。</li>
<li>不存在的話，拋出錯誤。</li>
</ol>
</li>
</ul>
<h3 id="flags"><a href="#flags" class="headerlink" title="flags"></a>flags</h3><div class="table-responsive">
<table class="table">
<thead>
<tr>
<th align="center">flags</th>
<th>name</th>
<th>為 1 時</th>
<th>為 0 時</th>
</tr>
</thead>
<tbody><tr>
<td align="center">P</td>
<td>Present</td>
<td>表示頁存在</td>
<td>不存在</td>
</tr>
<tr>
<td align="center">W</td>
<td>Writable</td>
<td>可以寫入</td>
<td>只能讀/取</td>
</tr>
<tr>
<td align="center">U</td>
<td>User</td>
<td>user 能使用此頁</td>
<td>只有 kernel 能使用</td>
</tr>
<tr>
<td align="center">WT</td>
<td>-</td>
<td>Write-through</td>
<td>Write-back</td>
</tr>
<tr>
<td align="center">CD</td>
<td>Cache Disable</td>
<td>不會對此頁進行 cache</td>
<td>進行 cache</td>
</tr>
<tr>
<td align="center">A</td>
<td>Accessed</td>
<td>為 0 時被存取， 處理器會將此位設為 1</td>
<td>-</td>
</tr>
<tr>
<td align="center">D</td>
<td>Dirty</td>
<td>為 0 時寫入此頁， 處理器會將此位設為 1</td>
<td>-</td>
</tr>
<tr>
<td align="center">AVL</td>
<td>Available for system use</td>
<td>-</td>
<td>-</td>
</tr>
</tbody></table>
</div><p><strong>註：</strong>只有軟體可以將 A、D 清 0。<sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[記憶體管理／分頁架構](https://www.csie.ntu.edu.tw/~wcchen/asm98/asm/proj/b85506061/chap2/paging.html)">[1]</span></a></sup></p>
<h3 id="名詞解釋"><a href="#名詞解釋" class="headerlink" title="名詞解釋"></a>名詞解釋</h3><ul>
<li>物理記憶體：DRAM</li>
<li>物理地址：DRAM 的位址</li>
</ul>
<hr>
<h2 id="Process-address-space"><a href="#Process-address-space" class="headerlink" title="Process address space"></a>Process address space</h2><ul>
<li><code>main</code> 呼叫 <code>kvmalloc</code> 跳到新的頁表，重新映射至記憶體。<br><img src="https://i.imgur.com/xq8Po1n.png" alt="" title="Layout of the virtual address space of a process and physical address space."></li>
<li>每個 process 都有自己的頁表，在切換 process 時也會切換頁表。</li>
<li>process 的頁表從 0 開始，最多至 <code>KERNBASE</code>，限制 process 最多使用 2GB。</li>
<li>如果需要更多記憶體時：<ol>
<li>XV6 先找到一個空的頁</li>
<li>將對應的 PTE 加入 process 的頁表裡</li>
</ol>
</li>
<li>每個 process 的頁表都有包含對應的 kernel 映射（ <code>KERNBASE</code> 之上），這樣當發生中斷時就不需要切換頁表。</li>
<li><code>KERNBASE</code> 之上的頁對應的 PTE，PTE_U 均設為 0。</li>
</ul>
<hr>
<h2 id="Code-建立-address-space"><a href="#Code-建立-address-space" class="headerlink" title="Code: 建立 address space"></a>Code: 建立 address space</h2><ul>
<li><code>main</code> 呼叫 <code>kvmalloc</code> 來建立 <code>KERNBASE</code> 之上的頁表</li>
</ul>
<h3 id="kvmalloc"><a href="#kvmalloc" class="headerlink" title="kvmalloc"></a>kvmalloc</h3><p id="kvmalloc"></p>

<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody><tr>
<td>建立 kernel page</td>
<td>void</td>
</tr>
</tbody></table>
</div><figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Allocate one page table for the machine for the kernel address</span></span><br><span class="line"><span class="comment">// space for scheduler processes.</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">kvmalloc(<span class="keyword">void</span>)</span><br><span class="line">{</span><br><span class="line">  kpgdir = setupkvm();</span><br><span class="line">  switchkvm();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>建立頁表的工作由 <code>setupkvm</code> 完成</li>
</ul>
<h3 id="setupkvm"><a href="#setupkvm" class="headerlink" title="setupkvm"></a>setupkvm</h3><div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody><tr>
<td>設定 kernel page</td>
<td>PDE</td>
</tr>
</tbody></table>
</div><figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Set up kernel part of a page table.</span></span><br><span class="line"><span class="keyword">pde_t</span>*</span><br><span class="line">setupkvm(<span class="keyword">void</span>)</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">pde_t</span> *pgdir;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">kmap</span> *<span class="title">k</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((pgdir = (<span class="keyword">pde_t</span>*)kalloc()) == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>首先分配一頁來存放目錄</li>
</ul>
<figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  <span class="built_in">memset</span>(pgdir, <span class="number">0</span>, PGSIZE);</span><br><span class="line">  <span class="keyword">if</span> (p2v(PHYSTOP) &gt; (<span class="keyword">void</span>*)DEVSPACE)</span><br><span class="line">    panic(<span class="string">"PHYSTOP too high"</span>);</span><br><span class="line">  <span class="keyword">for</span>(k = kmap; k &lt; &amp;kmap[NELEM(kmap)]; k++)</span><br><span class="line">    <span class="keyword">if</span>(mappages(pgdir, k-&gt;virt, k-&gt;phys_end - k-&gt;phys_start, </span><br><span class="line">                (uint)k-&gt;phys_start, k-&gt;perm) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> pgdir;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>接著呼叫 <code>mappages</code> 來建立 kernel 所需的映射。</li>
<li>映射存放在 kmap 裡</li>
</ul>
<hr>
<figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This table defines the kernel's mappings, which are present in</span></span><br><span class="line"><span class="comment">// every process's page table.</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">kmap</span> {</span></span><br><span class="line">  <span class="keyword">void</span> *virt;</span><br><span class="line">  uint phys_start;</span><br><span class="line">  uint phys_end;</span><br><span class="line">  <span class="keyword">int</span> perm;</span><br><span class="line">} kmap[] = {</span><br><span class="line"> { (<span class="keyword">void</span>*)KERNBASE, <span class="number">0</span>,             EXTMEM,    PTE_W}, <span class="comment">// I/O space</span></span><br><span class="line"> { (<span class="keyword">void</span>*)KERNLINK, V2P(KERNLINK), V2P(data), <span class="number">0</span>},     <span class="comment">// kern text+rodata</span></span><br><span class="line"> { (<span class="keyword">void</span>*)data,     V2P(data),     PHYSTOP,   PTE_W}, <span class="comment">// kern data+memory</span></span><br><span class="line"> { (<span class="keyword">void</span>*)DEVSPACE, DEVSPACE,      <span class="number">0</span>,         PTE_W}, <span class="comment">// more devices</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>kmap 包含 kernel 的資料及指令、<code>PHYTOP</code>以下的物理記憶體、及 I/O 設備的記憶體。</li>
<li>這裡不會建立有關 user 的映射</li>
</ul>
<h3 id="mappages"><a href="#mappages" class="headerlink" title="mappages"></a>mappages</h3><div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody><tr>
<td>設定 PTE</td>
<td>0 (ok) / -1 (err)</td>
</tr>
</tbody></table>
</div><figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create PTEs for virtual addresses starting at va that refer to</span></span><br><span class="line"><span class="comment">// physical addresses starting at pa. va and size might not</span></span><br><span class="line"><span class="comment">// be page-aligned.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">mappages(<span class="keyword">pde_t</span> *pgdir, <span class="keyword">void</span> *va, uint size, uint pa, <span class="keyword">int</span> perm)</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">char</span> *a, *last;</span><br><span class="line">  <span class="keyword">pte_t</span> *pte;</span><br><span class="line">  </span><br><span class="line">  a = (<span class="keyword">char</span>*)PGROUNDDOWN((uint)va);</span><br><span class="line">  last = (<span class="keyword">char</span>*)PGROUNDDOWN(((uint)va) + size - <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">for</span>(;;){</span><br><span class="line">    <span class="keyword">if</span>((pte = walkpgdir(pgdir, a, <span class="number">1</span>)) == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>首先呼叫 <code>walkpgdir</code> 來找到對應的 PTE</li>
</ul>
<figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(*pte &amp; PTE_P)</span><br><span class="line">  panic(<span class="string">"remap"</span>);</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>接著確認 PTE_P flags</li>
</ul>
<figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    *pte = pa | perm | PTE_P;</span><br><span class="line">    <span class="keyword">if</span>(a == last)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    a += PGSIZE;</span><br><span class="line">    pa += PGSIZE;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>最後初始化 PTE。</li>
<li>問題：如何初始化</li>
</ul>
<hr>
<p><i class="fa fa-code"></i> Code: <code>walkpgdir</code></p>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody><tr>
<td>從目錄尋找對應的 PTE</td>
<td>PTE</td>
</tr>
</tbody></table>
</div><div class="table-responsive">
<table class="table">
<thead>
<tr>
<th><code>*pgdir</code></th>
<th><code>*va</code></th>
<th><code>alloc</code></th>
</tr>
</thead>
<tbody><tr>
<td>目標目錄</td>
<td>目標虛擬地址</td>
<td>是否有 alloc</td>
</tr>
</tbody></table>
</div><figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Return the address of the PTE in page table pgdir</span></span><br><span class="line"><span class="comment">// that corresponds to virtual address va.  If alloc!=0,</span></span><br><span class="line"><span class="comment">// create any required page table pages.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">pte_t</span> *</span><br><span class="line">walkpgdir(<span class="keyword">pde_t</span> *pgdir, <span class="keyword">const</span> <span class="keyword">void</span> *va, <span class="keyword">int</span> alloc)</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">pde_t</span> *pde;</span><br><span class="line">  <span class="keyword">pte_t</span> *pgtab;</span><br><span class="line"></span><br><span class="line">  pde = &amp;pgdir[PDX(va)];</span><br><span class="line">  <span class="keyword">if</span>(*pde &amp; PTE_P){</span><br><span class="line">    pgtab = (<span class="keyword">pte_t</span>*)p2v(PTE_ADDR(*pde));</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="keyword">if</span>(!alloc || (pgtab = (<span class="keyword">pte_t</span>*)kalloc()) == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// Make sure all those PTE_P bits are zero.</span></span><br><span class="line">    <span class="built_in">memset</span>(pgtab, <span class="number">0</span>, PGSIZE);</span><br><span class="line">    <span class="comment">// The permissions here are overly generous, but they can</span></span><br><span class="line">    <span class="comment">// be further restricted by the permissions in the page table </span></span><br><span class="line">    <span class="comment">// entries, if necessary.</span></span><br><span class="line">    *pde = v2p(pgtab) | PTE_P | PTE_W | PTE_U;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> &amp;pgtab[PTX(va)];</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">switchkvm(<span class="keyword">void</span>)</span><br><span class="line">{</span><br><span class="line">  lcr3(v2p(kpgdir));   <span class="comment">// switch to the kernel page table</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<hr>
<h2 id="分配物理記憶體"><a href="#分配物理記憶體" class="headerlink" title="分配物理記憶體"></a>分配物理記憶體</h2><p>kernel 在運行時須為以下物件分配物理記憶體：</p>
<ul>
<li>Page table</li>
<li>Process 的 user 記憶體</li>
<li>kernel stack</li>
<li>Pipe buffers</li>
</ul>
<h2 id="Code-物理記憶體分配器"><a href="#Code-物理記憶體分配器" class="headerlink" title="Code: 物理記憶體分配器"></a>Code: 物理記憶體分配器</h2><blockquote>
<p>File: kalloc.c</p>
</blockquote>
<ul>
<li>分配器為一個可分配的記憶體頁所構成的 <strong>free list</strong></li>
<li><code>main</code> 呼叫 <code>kinit1(end, P2V(4*1024*1024))</code> 及 <code>kinit2(P2V(4*1024*1024), P2V(PHYSTOP))</code> 初始化分配器</li>
</ul>
<p id="kinit"></p>

<h3 id="kinit1-2"><a href="#kinit1-2" class="headerlink" title="kinit1 / 2"></a>kinit1 / 2</h3><p><i class="fa fa-code"></i> Code: <code>kinit1</code></p>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody><tr>
<td>初始化物理記憶體分配器</td>
<td>void</td>
</tr>
</tbody></table>
</div><div class="table-responsive">
<table class="table">
<thead>
<tr>
<th><code>*vstart</code></th>
<th><code>*vend</code></th>
</tr>
</thead>
<tbody><tr>
<td>起始位址</td>
<td>結束位址</td>
</tr>
</tbody></table>
</div><figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">kinit1(<span class="keyword">void</span> *vstart, <span class="keyword">void</span> *vend)</span><br><span class="line">{</span><br><span class="line">  initlock(&amp;kmem.lock, <span class="string">"kmem"</span>);</span><br><span class="line">  kmem.use_lock = <span class="number">0</span>;</span><br><span class="line">  freerange(vstart, vend);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<hr>
<p><i class="fa fa-code"></i> Code: <code>kinit2</code></p>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody><tr>
<td>初始化物理記憶體分配器</td>
<td>void</td>
</tr>
</tbody></table>
</div><div class="table-responsive">
<table class="table">
<thead>
<tr>
<th><code>*vstart</code></th>
<th><code>*vend</code></th>
</tr>
</thead>
<tbody><tr>
<td>起始位址</td>
<td>結束位址</td>
</tr>
</tbody></table>
</div><figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">kinit2(<span class="keyword">void</span> *vstart, <span class="keyword">void</span> *vend)</span><br><span class="line">{</span><br><span class="line">  freerange(vstart, vend);</span><br><span class="line">  kmem.use_lock = <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><code>kinit1 / 2</code> 呼叫 <code>freerange</code> 將記憶體加入 free list</li>
</ul>
<h3 id="freerange"><a href="#freerange" class="headerlink" title="freerange"></a>freerange</h3><div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody><tr>
<td>釋放一段記憶體</td>
<td>void</td>
</tr>
</tbody></table>
</div><div class="table-responsive">
<table class="table">
<thead>
<tr>
<th><code>*vstart</code></th>
<th><code>*vend</code></th>
</tr>
</thead>
<tbody><tr>
<td>起始位址</td>
<td>結束位址</td>
</tr>
</tbody></table>
</div><figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">freerange(<span class="keyword">void</span> *vstart, <span class="keyword">void</span> *vend)</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">char</span> *p;</span><br><span class="line">  p = (<span class="keyword">char</span>*)PGROUNDUP((uint)vstart);</span><br><span class="line">  <span class="keyword">for</span>(; p + PGSIZE &lt;= (<span class="keyword">char</span>*)vend; p += PGSIZE)</span><br><span class="line">    kfree(p);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><code>freerange</code> 呼叫 <code>kfree</code> 來完成工作</li>
</ul>
<h3 id="kfree"><a href="#kfree" class="headerlink" title="kfree"></a>kfree</h3><div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody><tr>
<td>釋放記憶體</td>
<td>void</td>
</tr>
</tbody></table>
</div><div class="table-responsive">
<table class="table">
<thead>
<tr>
<th><code>*v</code></th>
</tr>
</thead>
<tbody><tr>
<td>欲 free 的虛擬地址</td>
</tr>
</tbody></table>
</div><figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//PAGEBREAK: 21</span></span><br><span class="line"><span class="comment">// Free the page of physical memory pointed at by v,</span></span><br><span class="line"><span class="comment">// which normally should have been returned by a</span></span><br><span class="line"><span class="comment">// call to kalloc().  (The exception is when</span></span><br><span class="line"><span class="comment">// initializing the allocator; see kinit above.)</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">kfree(<span class="keyword">char</span> *v)</span><br><span class="line">{</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((uint)v % PGSIZE || v &lt; end || v2p(v) &gt;= PHYSTOP)</span><br><span class="line">    panic(<span class="string">"kfree"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Fill with junk to catch dangling refs.</span></span><br><span class="line">  <span class="built_in">memset</span>(v, <span class="number">1</span>, PGSIZE);</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>首先將每個字節設為 1</li>
</ul>
<figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(kmem.use_lock)</span><br><span class="line">    acquire(&amp;kmem.lock);</span><br><span class="line">  r = (struct run*)v;</span><br><span class="line">  r-&gt;next = kmem.freelist;</span><br><span class="line">  kmem.freelist = r;</span><br><span class="line">  <span class="keyword">if</span>(kmem.use_lock)</span><br><span class="line">    release(&amp;kmem.lock);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>接著把 v 轉為 <code>struct run</code> 的指標，插在 free list 的第一顆。</li>
</ul>
<hr>
<h2 id="User-part-of-an-address-space"><a href="#User-part-of-an-address-space" class="headerlink" title="User part of an address space"></a>User part of an address space</h2><p><img src="https://i.imgur.com/sZaPwda.png" alt="" title="Memory layout of a user process with its initial stack"></p>
<h2 id="Code-sbrk"><a href="#Code-sbrk" class="headerlink" title="Code: sbrk"></a>Code: sbrk</h2><div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody><tr>
<td>增長/收縮 process 的記憶體</td>
<td>記憶體大小（結果）</td>
</tr>
</tbody></table>
</div><figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">sys_sbrk(<span class="keyword">void</span>)</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">int</span> addr;</span><br><span class="line">  <span class="keyword">int</span> n;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(argint(<span class="number">0</span>, &amp;n) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  addr = proc-&gt;sz;</span><br><span class="line">  <span class="keyword">if</span>(growproc(n) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">return</span> addr;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><code>sbrk</code> 透過呼叫 <code>growproc</code> 來完成工作。</li>
</ul>
<hr>
<p><i class="fa fa-code"></i> Code: <code>growproc</code></p>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody><tr>
<td>增長/收縮 process 的記憶體</td>
<td>0 (ok) / -1 (err)</td>
</tr>
</tbody></table>
</div><div class="table-responsive">
<table class="table">
<thead>
<tr>
<th><code>n</code></th>
</tr>
</thead>
<tbody><tr>
<td>增長/收縮大小</td>
</tr>
</tbody></table>
</div><figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Grow current process's memory by n bytes.</span></span><br><span class="line"><span class="comment">// Return 0 on success, -1 on failure.</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">growproc(<span class="keyword">int</span> n)</span><br><span class="line">{</span><br><span class="line">  uint sz;</span><br><span class="line">  </span><br><span class="line">  sz = proc-&gt;sz;</span><br><span class="line">  <span class="keyword">if</span>(n &gt; <span class="number">0</span>){</span><br><span class="line">    <span class="keyword">if</span>((sz = allocuvm(proc-&gt;pgdir, sz, sz + n)) == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  } <span class="keyword">else</span> <span class="keyword">if</span>(n &lt; <span class="number">0</span>){</span><br><span class="line">    <span class="keyword">if</span>((sz = deallocuvm(proc-&gt;pgdir, sz, sz + n)) == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  }</span><br><span class="line">  proc-&gt;sz = sz;</span><br><span class="line">  switchuvm(proc);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>如果 n&gt;0：<code>allocuvm</code></li>
<li>如果 n&lt;0：<code>deallocuvm</code></li>
</ul>
<hr>
<h3 id="allocuvm、deallocuvm"><a href="#allocuvm、deallocuvm" class="headerlink" title="allocuvm、deallocuvm"></a>allocuvm、deallocuvm</h3><p><i class="fa fa-code"></i> Code: <code>allocuvm</code></p>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody><tr>
<td>增長記憶體</td>
<td>記憶體大小（結果）</td>
</tr>
</tbody></table>
</div><div class="table-responsive">
<table class="table">
<thead>
<tr>
<th><code>*pgdir</code></th>
<th><code>oldsz</code></th>
<th><code>newsz</code></th>
</tr>
</thead>
<tbody><tr>
<td>從該目錄尋找可用記憶體</td>
<td>舊的大小</td>
<td>新的大小</td>
</tr>
</tbody></table>
</div><figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Allocate page tables and physical memory to grow process from oldsz to</span></span><br><span class="line"><span class="comment">// newsz, which need not be page aligned.  Returns new size or 0 on error.</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">allocuvm(<span class="keyword">pde_t</span> *pgdir, uint oldsz, uint newsz)</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">char</span> *mem;</span><br><span class="line">  uint a;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(newsz &gt;= KERNBASE)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span>(newsz &lt; oldsz)</span><br><span class="line">    <span class="keyword">return</span> oldsz;</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>首先檢查是否有要超過大小，及動作是否合法。</li>
</ul>
<figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  a = PGROUNDUP(oldsz);</span><br><span class="line">  <span class="keyword">for</span>(; a &lt; newsz; a += PGSIZE){</span><br><span class="line">    mem = kalloc();</span><br><span class="line">    <span class="keyword">if</span>(mem == <span class="number">0</span>){</span><br><span class="line">      cprintf(<span class="string">"allocuvm out of memory\n"</span>);</span><br><span class="line">      deallocuvm(pgdir, newsz, oldsz);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">memset</span>(mem, <span class="number">0</span>, PGSIZE);</span><br><span class="line">    mappages(pgdir, (<span class="keyword">char</span>*)a, PGSIZE, v2p(mem), PTE_W|PTE_U);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> newsz;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>接著透過 <code>kalloc()</code> 來要記憶體，並將要到的記憶體清空</li>
<li>最後回傳 process 目前總共的大小</li>
</ul>
<hr>
<p><i class="fa fa-code"></i> Code: <code>deallocuvm</code></p>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody><tr>
<td>縮減記憶體</td>
<td>記憶體大小（結果）</td>
</tr>
</tbody></table>
</div><div class="table-responsive">
<table class="table">
<thead>
<tr>
<th><code>*pgdir</code></th>
<th><code>oldsz</code></th>
<th><code>newsz</code></th>
</tr>
</thead>
<tbody><tr>
<td>從該目錄釋放記憶體</td>
<td>舊的大小</td>
<td>新的大小</td>
</tr>
</tbody></table>
</div><figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Deallocate user pages to bring the process size from oldsz to</span></span><br><span class="line"><span class="comment">// newsz.  oldsz and newsz need not be page-aligned, nor does newsz</span></span><br><span class="line"><span class="comment">// need to be less than oldsz.  oldsz can be larger than the actual</span></span><br><span class="line"><span class="comment">// process size.  Returns the new process size.</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">deallocuvm(<span class="keyword">pde_t</span> *pgdir, uint oldsz, uint newsz)</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">pte_t</span> *pte;</span><br><span class="line">  uint a, pa;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(newsz &gt;= oldsz)</span><br><span class="line">    <span class="keyword">return</span> oldsz;</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>一樣先檢查動作是否合法</li>
</ul>
<figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  a = PGROUNDUP(newsz);</span><br><span class="line">  <span class="keyword">for</span>(; a  &lt; oldsz; a += PGSIZE){</span><br><span class="line">    pte = walkpgdir(pgdir, (<span class="keyword">char</span>*)a, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(!pte)</span><br><span class="line">      a += (NPTENTRIES - <span class="number">1</span>) * PGSIZE;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>((*pte &amp; PTE_P) != <span class="number">0</span>){</span><br><span class="line">      pa = PTE_ADDR(*pte);</span><br><span class="line">      <span class="keyword">if</span>(pa == <span class="number">0</span>)</span><br><span class="line">        panic(<span class="string">"kfree"</span>);</span><br><span class="line">      <span class="keyword">char</span> *v = p2v(pa);</span><br><span class="line">      kfree(v);</span><br><span class="line">      *pte = <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> newsz;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>接著一個一個 pte free，先將 flags 歸0，再透過 <code>kfree</code> 完成工作。</li>
</ul>
<hr>
<h2 id="Code-exec"><a href="#Code-exec" class="headerlink" title="Code: exec"></a>Code: exec</h2><ul>
<li>功用：創建 user part address space</li>
<li>概觀：打開及讀取 ELF 文件來初始化 user part</li>
</ul>
<h3 id="struct-elfhdr"><a href="#struct-elfhdr" class="headerlink" title="struct elfhdr"></a>struct elfhdr</h3><figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File header</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">elfhdr</span> {</span></span><br><span class="line">  uint magic;  <span class="comment">// must equal ELF_MAGIC</span></span><br><span class="line">  uchar elf[<span class="number">12</span>];</span><br><span class="line">  ushort type;</span><br><span class="line">  ushort machine;</span><br><span class="line">  uint version;</span><br><span class="line">  uint entry;</span><br><span class="line">  uint phoff;</span><br><span class="line">  uint shoff;</span><br><span class="line">  uint flags;</span><br><span class="line">  ushort ehsize;</span><br><span class="line">  ushort phentsize;</span><br><span class="line">  ushort phnum;</span><br><span class="line">  ushort shentsize;</span><br><span class="line">  ushort shnum;</span><br><span class="line">  ushort shstrndx;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>一個 ELF 文件包含一個 elfhdr、program setion hdr(struct proghdr)</li>
</ul>
<h3 id="struct-proghdr"><a href="#struct-proghdr" class="headerlink" title="struct proghdr"></a>struct proghdr</h3><figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Program section header</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proghdr</span> {</span></span><br><span class="line">  uint type;</span><br><span class="line">  uint off;</span><br><span class="line">  uint vaddr;</span><br><span class="line">  uint paddr;</span><br><span class="line">  uint filesz;</span><br><span class="line">  uint memsz;</span><br><span class="line">  uint flags;</span><br><span class="line">  uint align;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>一個 proghdr 描述了須載入至記憶體的 program section</li>
</ul>
<blockquote>
<p>XV6 的 program 只有一個 section，其他 OS 可能會有多個。</p>
</blockquote>
<h3 id="File-exec-c"><a href="#File-exec-c" class="headerlink" title="File: exec.c"></a>File: exec.c</h3><figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"param.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"memlayout.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"mmu.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"proc.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"defs.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"x86.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"elf.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">exec(<span class="keyword">char</span> *path, <span class="keyword">char</span> **argv)</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">char</span> *s, *last;</span><br><span class="line">  <span class="keyword">int</span> i, off;</span><br><span class="line">  uint argc, sz, sp, ustack[<span class="number">3</span>+MAXARG+<span class="number">1</span>];</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">elfhdr</span> <span class="title">elf</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">ip</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proghdr</span> <span class="title">ph</span>;</span></span><br><span class="line">  <span class="keyword">pde_t</span> *pgdir, *oldpgdir;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((ip = namei(path)) == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>用 <code>namei</code> 打開二進制文件（ch6 會說明）</li>
</ul>
<figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ilock(ip);</span><br><span class="line">pgdir = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check ELF header</span></span><br><span class="line"><span class="keyword">if</span>(readi(ip, (<span class="keyword">char</span>*)&amp;elf, <span class="number">0</span>, <span class="keyword">sizeof</span>(elf)) &lt; <span class="keyword">sizeof</span>(elf))</span><br><span class="line">  <span class="keyword">goto</span> bad;</span><br><span class="line"><span class="keyword">if</span>(elf.magic != ELF_MAGIC)</span><br><span class="line">  <span class="keyword">goto</span> bad;</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>接著確認 ELF 是否正確（藉由 ELF_magic）</li>
</ul>
<figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>((pgdir = setupkvm()) == <span class="number">0</span>)</span><br><span class="line">  <span class="keyword">goto</span> bad;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Load program into memory.</span></span><br><span class="line">sz = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>, off=elf.phoff; i&lt;elf.phnum; i++, off+=<span class="keyword">sizeof</span>(ph)){</span><br><span class="line">  <span class="keyword">if</span>(readi(ip, (<span class="keyword">char</span>*)&amp;ph, off, <span class="keyword">sizeof</span>(ph)) != <span class="keyword">sizeof</span>(ph))</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line">  <span class="keyword">if</span>(ph.type != ELF_PROG_LOAD)</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">  <span class="keyword">if</span>(ph.memsz &lt; ph.filesz)</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line">  <span class="keyword">if</span>((sz = allocuvm(pgdir, sz, ph.vaddr + ph.memsz)) == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line">  <span class="keyword">if</span>(loaduvm(pgdir, (<span class="keyword">char</span>*)ph.vaddr, ip, ph.off, ph.filesz) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line">}</span><br><span class="line">iunlockput(ip);</span><br><span class="line">ip = <span class="number">0</span>;</span><br></pre></td></tr></tbody></table></figure>

<ol>
<li><code>setupkvm</code> 分配一個沒有 user part 的頁</li>
<li><code>allocuvm</code> 分配給每個 ELF 的 program section 記憶體。</li>
<li><code>loaduvm</code> 將 section 載入至記憶體</li>
</ol>
<figure class="highlight c line_number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Allocate two pages at the next page boundary.</span></span><br><span class="line">  <span class="comment">// Make the first inaccessible.  Use the second as the user stack.</span></span><br><span class="line">  sz = PGROUNDUP(sz);</span><br><span class="line">  <span class="keyword">if</span>((sz = allocuvm(pgdir, sz, sz + <span class="number">2</span>*PGSIZE)) == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line">  clearpteu(pgdir, (<span class="keyword">char</span>*)(sz - <span class="number">2</span>*PGSIZE));</span><br><span class="line">  sp = sz;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Push argument strings, prepare rest of stack in ustack.</span></span><br><span class="line">  <span class="keyword">for</span>(argc = <span class="number">0</span>; argv[argc]; argc++) {</span><br><span class="line">    <span class="keyword">if</span>(argc &gt;= MAXARG)</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">    sp = (sp - (<span class="built_in">strlen</span>(argv[argc]) + <span class="number">1</span>)) &amp; ~<span class="number">3</span>;</span><br><span class="line">    <span class="keyword">if</span>(copyout(pgdir, sp, argv[argc], <span class="built_in">strlen</span>(argv[argc]) + <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">    ustack[<span class="number">3</span>+argc] = sp;</span><br><span class="line">  }</span><br><span class="line">  ustack[<span class="number">3</span>+argc] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  ustack[<span class="number">0</span>] = <span class="number">0xffffffff</span>;  <span class="comment">// fake return PC</span></span><br><span class="line">  ustack[<span class="number">1</span>] = argc;</span><br><span class="line">  ustack[<span class="number">2</span>] = sp - (argc+<span class="number">1</span>)*<span class="number">4</span>;  <span class="comment">// argv pointer</span></span><br><span class="line"></span><br><span class="line">  sp -= (<span class="number">3</span>+argc+<span class="number">1</span>) * <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">if</span>(copyout(pgdir, sp, ustack, (<span class="number">3</span>+argc+<span class="number">1</span>)*<span class="number">4</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Save program name for debugging.</span></span><br><span class="line">  <span class="keyword">for</span>(last=s=path; *s; s++)</span><br><span class="line">    <span class="keyword">if</span>(*s == <span class="string">'/'</span>)</span><br><span class="line">      last = s+<span class="number">1</span>;</span><br><span class="line">  safestrcpy(proc-&gt;name, last, <span class="keyword">sizeof</span>(proc-&gt;name));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Commit to the user image.</span></span><br><span class="line">  oldpgdir = proc-&gt;pgdir;</span><br><span class="line">  proc-&gt;pgdir = pgdir;</span><br><span class="line">  proc-&gt;sz = sz;</span><br><span class="line">  proc-&gt;tf-&gt;eip = elf.entry;  <span class="comment">// main</span></span><br><span class="line">  proc-&gt;tf-&gt;esp = sp;</span><br><span class="line">  switchuvm(proc);</span><br><span class="line">  freevm(oldpgdir);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"> bad:</span><br><span class="line">  <span class="keyword">if</span>(pgdir)</span><br><span class="line">    freevm(pgdir);</span><br><span class="line">  <span class="keyword">if</span>(ip)</span><br><span class="line">    iunlockput(ip);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><div id="footnotes"><hr class="clearfix"><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a href="https://www.csie.ntu.edu.tw/~wcchen/asm98/asm/proj/b85506061/chap2/paging.html" target="_blank" rel="noopener">記憶體管理／分頁架構</a><a href="#fnref:1" rev="footnote"> ↩</a></span></li></ol></div></div><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>

                
            </div>
            
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        


<a href="/tags/XV6/">#XV6</a> <a href="/tags/kernel/">#kernel</a> <a href="/tags/分頁/">#分頁</a> <a href="/tags/記憶體管理/">#記憶體管理</a>


                    
                </div>
            

            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="pager">
                        
                            <li class="previous"><a href="/xv6-3-trap/">&larr;  下一頁</a></li>
                        
                        
                            <li class="next"><a href="/xv6-1-process/">上一頁  &rarr;</a></li>
                        
                    </ul>
                </div>
            
            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article> 




    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/luswdev" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted footer-author">&copy; 2020 LuSkywalker</p>
                <ul class="copyright text-muted footer-menu">
                    
                        <li>
                            <a href="/">
                                
                                    Home
                                
                            </a>
                        </li>
                    
                        <li>
                            <a href="/archives">
                                
                                    Archives
                                
                            </a>
                        </li>
                    
                        <li>
                            <a href="/tags">
                                
                                    Tags
                                
                            </a>
                        </li>
                    
                        <li>
                            <a href="/categories">
                                
                                    Categories
                                
                            </a>
                        </li>
                    
                        <li>
                            <a href="/about">
                                
                                    About
                                
                            </a>
                        </li>
                    
                </ul>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments --><!-- hexo-inject:begin --><!-- hexo-inject:end -->



</body>

</html>